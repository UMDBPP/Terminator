Version 4
SHEET 1 880 1120
WIRE -1296 -320 -1392 -320
WIRE -1248 -320 -1296 -320
WIRE -1392 -288 -1392 -320
WIRE -1760 -256 -1872 -256
WIRE -1536 -256 -1680 -256
WIRE -1440 -256 -1536 -256
WIRE -1536 -224 -1632 -224
WIRE -1440 -224 -1536 -224
WIRE -1392 -192 -1392 -208
WIRE -480 -144 -608 -144
WIRE -432 -144 -480 -144
WIRE -368 -144 -432 -144
WIRE -1632 -128 -1632 -144
WIRE -976 -80 -992 -80
WIRE -880 -80 -896 -80
WIRE -480 -80 -480 -144
WIRE -432 -80 -432 -144
WIRE 80 -48 0 -48
WIRE 160 -48 80 -48
WIRE 384 -48 240 -48
WIRE 80 -32 80 -48
WIRE 0 -16 0 -48
WIRE -1872 0 -1872 -256
WIRE -992 16 -992 -80
WIRE -992 16 -1040 16
WIRE -976 16 -992 16
WIRE -880 16 -880 -80
WIRE -880 16 -896 16
WIRE -784 16 -880 16
WIRE -720 16 -784 16
WIRE -608 16 -608 -144
WIRE -608 16 -720 16
WIRE -480 16 -480 -16
WIRE -368 16 -368 -144
WIRE -256 16 -304 16
WIRE -176 16 -192 16
WIRE -880 32 -880 16
WIRE -784 32 -784 16
WIRE 80 48 80 32
WIRE 0 80 0 64
WIRE -432 96 -432 0
WIRE 384 96 384 -48
WIRE -1872 112 -1872 80
WIRE -1632 112 -1632 -48
WIRE -880 112 -880 96
WIRE -784 112 -784 96
WIRE -608 160 -608 16
WIRE -592 160 -608 160
WIRE -256 160 -256 16
WIRE -256 160 -272 160
WIRE 336 176 272 176
WIRE -1296 240 -1392 240
WIRE -1248 240 -1296 240
WIRE -848 256 -896 256
WIRE -592 256 -768 256
WIRE 272 256 272 176
WIRE 272 256 -272 256
WIRE -1392 272 -1392 240
WIRE 384 288 384 192
WIRE 384 288 272 288
WIRE 512 288 384 288
WIRE 624 288 624 224
WIRE 624 288 592 288
WIRE 656 288 624 288
WIRE 752 288 752 224
WIRE 752 288 736 288
WIRE -1536 336 -1632 336
WIRE -1440 336 -1536 336
WIRE 384 336 384 288
WIRE 624 336 624 288
WIRE 752 336 752 288
WIRE -720 352 -720 16
WIRE -688 352 -720 352
WIRE -592 352 -608 352
WIRE -176 352 -176 16
WIRE -176 352 -272 352
WIRE 272 352 272 288
WIRE 272 352 -176 352
WIRE -2144 368 -2160 368
WIRE -2016 368 -2064 368
WIRE -1936 368 -2016 368
WIRE -1392 368 -1392 352
WIRE 336 416 272 416
WIRE -2160 432 -2160 368
WIRE -1632 432 -1632 416
WIRE -848 448 -896 448
WIRE -592 448 -768 448
WIRE 272 448 272 416
WIRE 272 448 -272 448
WIRE 384 464 384 432
WIRE 624 464 624 400
WIRE 752 464 752 416
WIRE -2160 544 -2160 512
WIRE -592 544 -608 544
WIRE -256 544 -272 544
WIRE -2128 608 -2160 608
WIRE -2016 608 -2048 608
WIRE -1936 608 -2016 608
WIRE -608 624 -608 544
WIRE -432 624 -432 608
WIRE -432 624 -608 624
WIRE -256 624 -256 544
WIRE -256 624 -432 624
WIRE -432 640 -432 624
WIRE -2160 672 -2160 608
WIRE -1632 672 -1632 512
WIRE -2160 784 -2160 752
WIRE -1248 800 -1344 800
WIRE -1232 800 -1248 800
WIRE -832 800 -976 800
WIRE -784 800 -832 800
WIRE -720 800 -784 800
WIRE -2128 832 -2160 832
WIRE -2016 832 -2048 832
WIRE -1936 832 -2016 832
WIRE -1248 880 -1248 800
WIRE -1232 880 -1248 880
WIRE -832 880 -976 880
WIRE -720 880 -720 800
WIRE -2160 896 -2160 832
WIRE -832 912 -832 880
WIRE -1232 960 -1296 960
WIRE -928 960 -976 960
WIRE -1296 976 -1296 960
WIRE -928 976 -928 960
WIRE -720 992 -720 944
WIRE -2160 1008 -2160 976
WIRE -832 1008 -832 992
WIRE -1232 1040 -1296 1040
WIRE -928 1040 -976 1040
WIRE -1296 1104 -1296 1040
FLAG 384 464 0
FLAG 624 464 0
FLAG 752 464 0
FLAG 0 80 0
FLAG 80 48 0
FLAG -432 640 0
FLAG -784 112 0
FLAG -896 448 top_pwm
FLAG -896 256 bot_pwm
FLAG -1536 -256 ramp
FLAG -1536 -224 triangle
FLAG -1872 112 0
FLAG -1632 112 0
FLAG -1296 -320 top_pwm
FLAG -1392 -192 0
FLAG -1536 336 bot_triangle
FLAG -1632 672 0
FLAG -1296 240 bot_pwm
FLAG -1392 368 0
FLAG -2160 544 0
FLAG -2016 368 control
FLAG -2160 784 0
FLAG -2016 608 err
FLAG 624 224 SNSP
FLAG 752 224 SNSN
FLAG -2160 1008 0
FLAG -2016 832 err_int
FLAG -480 16 0
FLAG -880 112 0
FLAG 80 -48 batt
FLAG -1344 800 batt
FLAG -1296 1104 0
FLAG -784 800 chg_pmp
FLAG -832 1008 0
FLAG -1040 16 chg_pmp
FLAG -720 992 0
SYMBOL ind 496 304 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L1
SYMATTR Value 4.7µ
SYMATTR SpiceLine Rser=44m
SYMBOL Cap 608 336 R0
SYMATTR InstName C1
SYMATTR Value 22µ
SYMBOL nmos 336 96 R0
SYMATTR InstName M1
SYMATTR Value BSG0811NDQ2
SYMBOL nmos 336 336 R0
SYMATTR InstName M2
SYMATTR Value BSG0811NDQ2
SYMBOL Res 736 320 R0
SYMATTR InstName R1
SYMATTR Value 1
SYMBOL Voltage 0 -32 R0
SYMATTR InstName V1
SYMATTR Value 3.7
SYMATTR SpiceLine Rser=40m
SYMBOL Cap 64 -32 R0
SYMATTR InstName C2
SYMATTR Value 22µ
SYMBOL LTC7061 -432 352 R0
SYMATTR InstName U1
SYMBOL schottky -368 32 R270
WINDOW 0 32 32 VTop 2
WINDOW 3 0 32 VBottom 2
SYMATTR InstName D1
SYMATTR Value 1N5817
SYMBOL Cap -192 0 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C3
SYMATTR Value 220n
SYMBOL Res -592 336 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value 51k
SYMBOL Cap -800 32 R0
SYMATTR InstName C4
SYMATTR Value 0.22µ
SYMBOL Voltage -1872 -16 R0
SYMATTR InstName V3
SYMATTR Value PWL(0 0 1m 0 2m 1)
SYMATTR SpiceLine Rser=1m
SYMBOL Voltage -1632 -144 R0
SYMATTR InstName V4
SYMATTR Value PULSE(0 100 0 1u 1u 1n 2u)
SYMATTR SpiceLine Rser=1m
SYMBOL bv -1392 -304 R0
SYMATTR InstName B1
SYMATTR Value V=if((V(control)>V(triangle)),1.8,0)
SYMBOL Voltage -1632 416 R0
SYMATTR InstName V6
SYMATTR Value PULSE(0 100 0 1u 1u 1n 2u)
SYMATTR SpiceLine Rser=1m
SYMBOL bv -1392 256 R0
SYMATTR InstName B2
SYMATTR Value V=if((V(control)<V(triangle)),1.8,0)
SYMBOL bv -2160 416 R0
SYMATTR InstName B3
SYMATTR Value V=0+(((10*V(err))+(1000*V(err_int))))
SYMBOL Res 752 272 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R3
SYMATTR Value 5m
SYMBOL bv -2160 656 R0
SYMATTR InstName B4
SYMATTR Value V=(V(ramp)*(3-((V(SNSP)-V(SNSN))/0.005)))
SYMBOL bv -2160 880 R0
SYMATTR InstName B5
SYMATTR Value V=(idt(V(ERR)))
SYMBOL Res -448 -96 R0
SYMATTR InstName R4
SYMATTR Value 10
SYMBOL Cap -496 -80 R0
SYMATTR InstName C5
SYMATTR Value 1µ
SYMBOL Cap -896 32 R0
SYMATTR InstName C6
SYMATTR Value 10µ
SYMBOL LTC1751 -1104 928 R0
SYMATTR InstName U2
SYMBOL Cap -944 976 R0
SYMATTR InstName C7
SYMATTR Value 1µ
SYMBOL Res -848 784 R0
SYMATTR InstName R5
SYMATTR Value 72.9k
SYMBOL Res -848 896 R0
SYMATTR InstName R6
SYMATTR Value 10k
SYMBOL Cap -736 880 R0
SYMATTR InstName C8
SYMATTR Value 10µ
SYMBOL Cap -1312 976 R0
SYMATTR InstName C9
SYMATTR Value 8n
SYMBOL ind -992 32 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L2
SYMATTR Value 1µ
SYMATTR SpiceLine Rser=1m
SYMBOL Res -880 -96 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R7
SYMATTR Value 50m
SYMBOL Res -1664 -272 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R8
SYMATTR Value 1m
SYMBOL Res -1648 -240 R0
SYMATTR InstName R9
SYMATTR Value 1m
SYMBOL Res -2048 352 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R10
SYMATTR Value 1m
SYMBOL Res -2032 592 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R11
SYMATTR Value 1m
SYMBOL Res -2032 816 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R12
SYMATTR Value 1m
SYMBOL Res -1648 320 R0
SYMATTR InstName R13
SYMATTR Value 1m
SYMBOL Res -752 240 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R14
SYMATTR Value 1m
SYMBOL Res -752 432 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R15
SYMATTR Value 1m
SYMBOL Res 256 -64 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R16
SYMATTR Value 1m
TEXT -568 -344 Left 2 !.tran 0 1 0 10n
